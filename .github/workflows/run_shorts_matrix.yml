# .github/workflows/run_shorts_matrix.yml
name: Run Shorts (matrix)

on:
  workflow_dispatch:
    inputs:
      slot:
        description: "slot (midday/close/open)"
        required: true
        default: "midday"
        type: choice
        options:
          - open
          - midday
          - close

      images_ymd:
        description: "images ymd (latest | payload | requested | YYYY-MM-DD)"
        required: true
        default: "latest"
        type: string

      markets:
        description: "markets to run: all | au | au,us,tw"
        required: false
        default: "all"
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      markets_normalized: ${{ steps.set-matrix.outputs.markets_normalized }}

    steps:
      - name: Build matrix
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail
          ALL="cn tw jp kr th us ca uk au"

          raw="${{ inputs.markets }}"
          raw="$(echo "$raw" | tr '[:upper:]' '[:lower:]' | tr -d ' ')"

          if [ -z "$raw" ] || [ "$raw" = "all" ] || [ "$raw" = "*" ]; then
            selected="$ALL"
          else
            IFS=',' read -r -a arr <<< "$raw"
            selected=""
            for m in "${arr[@]}"; do
              if echo " $ALL " | grep -q " $m "; then
                selected="$selected $m"
              else
                echo "::error::Invalid market '$m'"
                exit 1
              fi
            done
            selected="$(echo "$selected" | xargs)"
          fi

          json='{"market":['
          first=1
          for m in $selected; do
            if [ $first -eq 1 ]; then first=0; else json="$json,"; fi
            json="$json\"$m\""
          done
          json="$json]}"

          echo "markets_normalized=$selected" >> "$GITHUB_OUTPUT"
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  run:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    env:
      MPLBACKEND: Agg

      # ✅ isolate matplotlib config/cache per matrix job
      MPLCONFIGDIR: $RUNNER_TEMP/mpl-${{ matrix.market }}

      RUN_SHORTS_DEBUG_TREE: "1"
      OVERVIEW_DEBUG_FONTS: "1"
      OVERVIEW_DEBUG_FOOTER: "1"

      # Drive root folder (your choice)
      GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID }}

      # YouTube secrets
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      YOUTUBE_PLAYLIST_MAP_JSON: ${{ secrets.YOUTUBE_PLAYLIST_MAP_JSON }}

      # (Optional) Drive creds if your drive_uploader reads these
      # If you don't have these secrets, leaving them here is OK (empty env var)
      GDRIVE_TOKEN_JSON_B64: ${{ secrets.GDRIVE_TOKEN_JSON_B64 }}
      GDRIVE_CLIENT_SECRET_JSON_B64: ${{ secrets.GDRIVE_CLIENT_SECRET_JSON_B64 }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ============================================================
      # SYSTEM DEPENDENCIES + FULL FONT STACK (CJK/TH/Emoji)
      # ============================================================
      - name: Install system deps (FULL FONT STACK)
        shell: bash
        run: |
          set -euxo pipefail

          sudo apt-get update

          # video/font infra
          sudo apt-get install -y \
            ffmpeg \
            fontconfig

          # core fallbacks (DejaVu)
          sudo apt-get install -y \
            fonts-dejavu-core \
            fonts-dejavu-extra

          # ✅ Noto stacks
          sudo apt-get install -y \
            fonts-noto-cjk \
            fonts-noto-core || true

          # emoji (some runners may not have it)
          sudo apt-get install -y fonts-noto-color-emoji || true

          # Optional but often helpful on runner images
          sudo apt-get install -y \
            fonts-noto-extra \
            fonts-noto-ui-core \
            fonts-noto-unhinted || true

          # Some runner images provide this, some don't
          sudo apt-get install -y fonts-noto-cjk-extra || true

          sudo fc-cache -f -v

          echo "---- fc-list (CJK/TC/SC/KR candidates) ----"
          fc-list | grep -iE "noto sans (cjk|tc|sc|kr)|noto serif (cjk|tc|sc|kr)|noto sans (tc|sc|kr)" || true
          echo "------------------------------------------"

          rm -rf ~/.cache/matplotlib ~/.config/matplotlib || true
          rm -rf "${MPLCONFIGDIR}" || true
          mkdir -p "${MPLCONFIGDIR}"

      # ============================================================
      # PYTHON DEPENDENCIES
      # ============================================================
      - name: Install Python deps
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            pip install -r requirements-ci.txt
          else
            pip install -r requirements.txt
          fi

      # ============================================================
      # FONT VERIFY (matplotlib view)
      # ============================================================
      - name: Rebuild matplotlib font manager (verify)
        shell: bash
        run: |
          set -euxo pipefail
          python - <<'PY'
          import os
          import matplotlib
          matplotlib.use("Agg")
          from matplotlib import font_manager as fm

          print("MPLCONFIGDIR:", os.environ.get("MPLCONFIGDIR"))
          fm._load_fontmanager(try_read_cache=False)

          names = sorted({f.name for f in fm.fontManager.ttflist})
          print("Fonts count:", len(names))
          print("Thai sample:", [n for n in names if "thai" in n.lower()][:30])
          print("CJK sample :", [n for n in names if "cjk" in n.lower()][:30])
          PY

      - name: Verify fontconfig families (fc-list)
        shell: bash
        run: |
          set -euxo pipefail
          echo "[fc-list grep]"
          fc-list | grep -iE "noto sans (cjk|tc|sc|kr)|noto serif (cjk|tc|sc|kr)|noto sans (tc|sc|kr)" || true

      - name: Ensure output directories
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p media/images media/videos outputs

      # ============================================================
      # RUN SHORTS (restore "token-only upload works" behavior)
      # ============================================================
      - name: Run shorts
        shell: bash
        run: |
          set -euxo pipefail

          # ✅ Debug lengths (no secret content)
          echo "YT_TOKEN_LEN=${#YOUTUBE_TOKEN_JSON}  YT_PLAYLIST_LEN=${#YOUTUBE_PLAYLIST_MAP_JSON}"

          # Base args (same as your original)
          args=(
            --market ${{ matrix.market }}
            --slot ${{ inputs.slot }}
            --full
            --drive
            --drive-parent-id "${GDRIVE_ROOT_FOLDER_ID}"
            --drive-order after_youtube
            --drive-upload both
            --drive-images-mode zip
            --images-ymd ${{ inputs.images_ymd }}
          )

          # ✅ Key change: only require YOUTUBE_TOKEN_JSON to upload
          if [ -z "${YOUTUBE_TOKEN_JSON:-}" ]; then
            echo "::warning::Missing YOUTUBE_TOKEN_JSON -> skip upload"
            args+=( --skip-upload )
          else
            # If playlist map missing, still upload but skip playlist (old behavior friendly)
            if [ -z "${YOUTUBE_PLAYLIST_MAP_JSON:-}" ]; then
              echo "::warning::Missing YOUTUBE_PLAYLIST_MAP_JSON -> will skip playlist"
              args+=( --skip-playlist )
            fi
          fi

          python scripts/run_shorts.py "${args[@]}"

      # ============================================================
      # UPLOAD ARTIFACTS
      # ============================================================
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifacts_${{ matrix.market }}
          path: |
            outputs/**
            media/videos/**
            media/images/**
          if-no-files-found: ignore