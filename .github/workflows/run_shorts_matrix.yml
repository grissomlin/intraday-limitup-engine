# .github/workflows/run_shorts_matrix.yml
name: Run Shorts (matrix)

on:
  workflow_dispatch:
    inputs:
      slot:
        description: "slot (midday/close/open)"
        required: true
        default: "midday"
        type: choice
        options:
          - open
          - midday
          - close

      images_ymd:
        description: "images ymd (latest | payload | requested | YYYY-MM-DD)"
        required: true
        default: "latest"
        type: string

      markets:
        description: "markets to run: all | au | au,us,tw"
        required: false
        default: "all"
        type: string

  # ✅ Optional: enable schedule if you want always-on automation
  # schedule:
  #   - cron: "*/10 * * * *"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      markets_normalized: ${{ steps.set-matrix.outputs.markets_normalized }}

    steps:
      - name: Build matrix
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail
          ALL="cn tw jp kr th us ca uk au"

          raw="${{ inputs.markets }}"
          raw="$(echo "$raw" | tr '[:upper:]' '[:lower:]' | tr -d ' ')"

          if [ -z "$raw" ] || [ "$raw" = "all" ] || [ "$raw" = "*" ]; then
            selected="$ALL"
          else
            IFS=',' read -r -a arr <<< "$raw"
            selected=""
            for m in "${arr[@]}"; do
              if echo " $ALL " | grep -q " $m "; then
                selected="$selected $m"
              else
                echo "::error::Invalid market '$m'"
                exit 1
              fi
            done
            selected="$(echo "$selected" | xargs)"
          fi

          json='{"market":['
          first=1
          for m in $selected; do
            if [ $first -eq 1 ]; then first=0; else json="$json,"; fi
            json="$json\"$m\""
          done
          json="$json]}"

          echo "markets_normalized=$selected" >> "$GITHUB_OUTPUT"
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  run:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    env:
      MPLBACKEND: Agg

      # ✅ isolate matplotlib config/cache per matrix job
      MPLCONFIGDIR: $RUNNER_TEMP/mpl-${{ matrix.market }}

      RUN_SHORTS_DEBUG_TREE: "1"
      OVERVIEW_DEBUG_FONTS: "1"
      OVERVIEW_DEBUG_FOOTER: "1"

      # ✅ Google Drive (root + creds)
      GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID }}
      GDRIVE_TOKEN_JSON_B64: ${{ secrets.GDRIVE_TOKEN_JSON_B64 }}
      GDRIVE_CLIENT_SECRET_JSON_B64: ${{ secrets.GDRIVE_CLIENT_SECRET_JSON_B64 }}

      # ✅ YouTube
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      YOUTUBE_PLAYLIST_MAP_JSON: ${{ secrets.YOUTUBE_PLAYLIST_MAP_JSON }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ============================================================
      # SYSTEM DEPENDENCIES + FULL FONT STACK (CJK/TH/Emoji)
      # ============================================================
      - name: Install system deps (FULL FONT STACK)
        shell: bash
        run: |
          set -euxo pipefail

          sudo apt-get update

          # video/font infra
          sudo apt-get install -y \
            ffmpeg \
            fontconfig

          # core fallbacks (DejaVu)
          sudo apt-get install -y \
            fonts-dejavu-core \
            fonts-dejavu-extra

          # ✅ Noto stacks
          sudo apt-get install -y \
            fonts-noto-cjk \
            fonts-noto-core || true

          # emoji (some runners may not have it)
          sudo apt-get install -y fonts-noto-color-emoji || true

          # Optional but often helpful on runner images
          sudo apt-get install -y \
            fonts-noto-extra \
            fonts-noto-ui-core \
            fonts-noto-unhinted || true

          # Some runner images provide this, some don't
          sudo apt-get install -y fonts-noto-cjk-extra || true

          # Rebuild fontconfig cache
          sudo fc-cache -f -v

          # Quick sanity listing (shows whether TC/KR/SC exist and how they are NAMED)
          echo "---- fc-list (CJK/TC/SC/KR candidates) ----"
          fc-list | grep -iE "noto sans (cjk|tc|sc|kr)|noto serif (cjk|tc|sc|kr)|noto sans (tc|sc|kr)" || true
          echo "------------------------------------------"

          # Clear matplotlib cache (global)
          rm -rf ~/.cache/matplotlib ~/.config/matplotlib || true

          # Clear isolated MPLCONFIGDIR (per job)
          rm -rf "${MPLCONFIGDIR}" || true
          mkdir -p "${MPLCONFIGDIR}"

      # ============================================================
      # PYTHON DEPENDENCIES
      # ============================================================
      - name: Install Python deps
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            pip install -r requirements-ci.txt
          else
            pip install -r requirements.txt
          fi

      # ============================================================
      # FORCE MATPLOTLIB FONT REBUILD + VERIFY (matplotlib view)
      # ============================================================
      - name: Rebuild matplotlib font manager (verify)
        shell: bash
        run: |
          set -euxo pipefail
          python - <<'PY'
          import os
          import matplotlib
          matplotlib.use("Agg")
          from matplotlib import font_manager as fm
          import matplotlib.pyplot as plt

          print("MPLCONFIGDIR:", os.environ.get("MPLCONFIGDIR"))
          fm._load_fontmanager(try_read_cache=False)

          names = sorted({f.name for f in fm.fontManager.ttflist})
          print("Fonts count:", len(names))

          want = [
              "Noto Sans",
              "DejaVu Sans",
              "Noto Sans CJK JP",
              "Noto Sans CJK KR",
              "Noto Sans CJK SC",
              "Noto Sans CJK TC",
              "Noto Sans KR",
              "Noto Sans SC",
              "Noto Sans TC",
              "Noto Serif CJK JP",
              "Noto Color Emoji",
              "Noto Sans Thai",
              "Noto Sans Thai UI",
              "Noto Looped Thai",
              "Noto Looped Thai UI",
          ]

          print("\n[FONT CHECK]")
          for n in want:
              print(f"{n:22} : {'OK' if n in names else 'MISSING'}")

          print("\n[rcParams preview]")
          print("  font.family     =", plt.rcParams.get("font.family"))
          print("  font.sans-serif =", (plt.rcParams.get("font.sans-serif") or [])[:30])
          PY

      - name: Verify fontconfig families (fc-list)
        shell: bash
        run: |
          set -euxo pipefail
          echo "[fc-list grep]"
          fc-list | grep -iE "noto sans (cjk|tc|sc|kr)|noto serif (cjk|tc|sc|kr)|noto sans (tc|sc|kr)" || true

      - name: Ensure output directories
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p media/images media/videos outputs

      # ============================================================
      # RUN SHORTS (default: upload YouTube + Drive if secrets exist)
      # ============================================================
      - name: Run shorts
        shell: bash
        run: |
          set -euxo pipefail

          # Determine whether secrets exist (do NOT print secret content)
          yt_ok=1
          if [ -z "${YOUTUBE_TOKEN_JSON:-}" ] || [ -z "${YOUTUBE_PLAYLIST_MAP_JSON:-}" ]; then
            yt_ok=0
          fi

          drive_ok=1
          if [ -z "${GDRIVE_ROOT_FOLDER_ID:-}" ] || [ -z "${GDRIVE_TOKEN_JSON_B64:-}" ]; then
            drive_ok=0
          fi

          args=(
            --market ${{ matrix.market }}
            --slot ${{ inputs.slot }}
            --full
            --images-ymd ${{ inputs.images_ymd }}
          )

          if [ $yt_ok -eq 1 ]; then
            echo "[upload] YouTube enabled"
          else
            echo "[upload] YouTube DISABLED (missing secrets) -> --skip-upload"
            args+=( --skip-upload )
          fi

          if [ $drive_ok -eq 1 ]; then
            echo "[upload] Drive enabled"
            args+=(
              --drive
              --drive-parent-id "${GDRIVE_ROOT_FOLDER_ID}"
              --drive-order after_youtube
              --drive-upload both
              --drive-images-mode zip
            )
          else
            echo "[upload] Drive DISABLED (missing secrets)"
          fi

          python scripts/run_shorts.py "${args[@]}"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifacts_${{ matrix.market }}
          path: |
            outputs/**
            media/videos/**
            media/images/**
          if-no-files-found: ignore
