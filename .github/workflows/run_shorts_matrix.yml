# .github/workflows/run_shorts_matrix.yml
name: Run Shorts (matrix)

on:
  workflow_dispatch:
    inputs:
      slot:
        description: "slot (midday/close/open)"
        required: true
        default: "midday"
        type: choice
        options:
          - open
          - midday
          - close

      images_ymd:
        description: "images ymd (latest | payload | requested | YYYY-MM-DD)"
        required: true
        default: "latest"
        type: string

      # ✅ Markets (checkbox style via boolean inputs)
      m_cn:
        description: "CN"
        required: false
        type: boolean
        default: true
      m_tw:
        description: "TW"
        required: false
        type: boolean
        default: true
      m_jp:
        description: "JP"
        required: false
        type: boolean
        default: true
      m_kr:
        description: "KR"
        required: false
        type: boolean
        default: true
      m_th:
        description: "TH"
        required: false
        type: boolean
        default: true
      m_hk:
        description: "HK"
        required: false
        type: boolean
        default: true

      m_us:
        description: "US"
        required: false
        type: boolean
        default: true
      m_ca:
        description: "CA"
        required: false
        type: boolean
        default: true
      m_uk:
        description: "UK"
        required: false
        type: boolean
        default: true
      m_au:
        description: "AU"
        required: false
        type: boolean
        default: true
      m_in:
        description: "IN"
        required: false
        type: boolean
        default: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      markets_normalized: ${{ steps.set-matrix.outputs.markets_normalized }}

    steps:
      - name: Build matrix from checkboxes
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          ALL="cn tw jp kr th hk us ca uk au in"
          selected=""

          add_if_true () {
            local flag="$1"
            local mkt="$2"
            if [ "$flag" = "true" ]; then
              selected="$selected $mkt"
            fi
          }

          add_if_true "${{ inputs.m_cn }}" "cn"
          add_if_true "${{ inputs.m_tw }}" "tw"
          add_if_true "${{ inputs.m_jp }}" "jp"
          add_if_true "${{ inputs.m_kr }}" "kr"
          add_if_true "${{ inputs.m_th }}" "th"
          add_if_true "${{ inputs.m_hk }}" "hk"
          add_if_true "${{ inputs.m_us }}" "us"
          add_if_true "${{ inputs.m_ca }}" "ca"
          add_if_true "${{ inputs.m_uk }}" "uk"
          add_if_true "${{ inputs.m_au }}" "au"
          add_if_true "${{ inputs.m_in }}" "in"

          selected="$(echo "$selected" | xargs)"

          # ✅ If user unchecked everything, default to ALL (same behavior as your old "all")
          if [ -z "$selected" ]; then
            selected="$ALL"
          fi

          # Validate (defensive)
          for m in $selected; do
            if ! echo " $ALL " | grep -q " $m "; then
              echo "::error::Invalid market '$m'"
              exit 1
            fi
          done

          json='{"market":['
          first=1
          for m in $selected; do
            if [ $first -eq 1 ]; then first=0; else json="$json,"; fi
            json="$json\"$m\""
          done
          json="$json]}"

          echo "markets_normalized=$selected" >> "$GITHUB_OUTPUT"
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  run:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    env:
      MPLBACKEND: Agg
      MPLCONFIGDIR: $RUNNER_TEMP/mpl-${{ matrix.market }}

      RUN_SHORTS_DEBUG_TREE: "1"
      OVERVIEW_DEBUG_FONTS: "1"
      OVERVIEW_DEBUG_FOOTER: "1"

      # Drive root folder
      GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID }}

      # YouTube token (required for upload)
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}

      # (Optional) Drive creds
      GDRIVE_TOKEN_JSON_B64: ${{ secrets.GDRIVE_TOKEN_JSON_B64 }}
      GDRIVE_CLIENT_SECRET_JSON_B64: ${{ secrets.GDRIVE_CLIENT_SECRET_JSON_B64 }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps (FULL FONT STACK)
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y ffmpeg fontconfig
          sudo apt-get install -y fonts-dejavu-core fonts-dejavu-extra
          sudo apt-get install -y fonts-noto-cjk fonts-noto-core || true
          sudo apt-get install -y fonts-noto-color-emoji || true
          sudo apt-get install -y fonts-noto-extra fonts-noto-ui-core fonts-noto-unhinted || true
          sudo apt-get install -y fonts-noto-cjk-extra || true
          sudo fc-cache -f -v
          rm -rf ~/.cache/matplotlib ~/.config/matplotlib || true
          rm -rf "${MPLCONFIGDIR}" || true
          mkdir -p "${MPLCONFIGDIR}"

      - name: Install Python deps
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            pip install -r requirements-ci.txt
          else
            pip install -r requirements.txt
          fi

      - name: Ensure output directories
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p media/images media/videos outputs

      - name: Run shorts
        shell: bash
        run: |
          set -euxo pipefail

          echo "markets_selected=${{ needs.prepare.outputs.markets_normalized }}"
          echo "YT_TOKEN_LEN=${#YOUTUBE_TOKEN_JSON}"

          args=(
            --market ${{ matrix.market }}
            --slot ${{ inputs.slot }}
            --full
            --drive
            --drive-parent-id "${GDRIVE_ROOT_FOLDER_ID}"
            --drive-order after_youtube
            --drive-upload both
            --drive-images-mode zip
            --images-ymd ${{ inputs.images_ymd }}
          )

          # ✅ Only require token to upload. Playlist map uses repo file by default.
          if [ -z "${YOUTUBE_TOKEN_JSON:-}" ]; then
            echo "::warning::Missing YOUTUBE_TOKEN_JSON -> skip upload"
            args+=( --skip-upload )
          fi

          # ✅ Do NOT skip playlist just because secret missing.
          # scripts/run_shorts.py already defaults to config/youtube_playlists.json
          python scripts/run_shorts.py "${args[@]}"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifacts_${{ matrix.market }}
          path: |
            outputs/**
            media/videos/**
            media/images/**
          if-no-files-found: ignore
