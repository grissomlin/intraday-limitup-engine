name: Run Shorts (matrix)

on:
  workflow_dispatch:
    inputs:
      slot:
        description: "slot (midday/close/open)"
        required: true
        default: "midday"
        type: choice
        options:
          - open
          - midday
          - close

      images_ymd:
        description: "images ymd (latest | payload | requested | YYYY-MM-DD)"
        required: true
        default: "latest"
        type: string

      markets:
        description: "markets to run: all | au | au,us,tw (comma-separated, case-insensitive)"
        required: false
        default: "all"
        type: string

jobs:
  prepare:
    name: Prepare matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      markets_normalized: ${{ steps.set-matrix.outputs.markets_normalized }}
    steps:
      - name: Build matrix from input
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          # Canonical list (your original)
          ALL="cn tw jp kr th us ca uk au"

          raw="${{ inputs.markets }}"
          raw="$(echo "$raw" | tr '[:upper:]' '[:lower:]' | tr -d ' ')"

          if [ -z "$raw" ] || [ "$raw" = "all" ] || [ "$raw" = "*" ]; then
            selected="$ALL"
          else
            # split by comma
            IFS=',' read -r -a arr <<< "$raw"
            selected=""
            for m in "${arr[@]}"; do
              [ -z "$m" ] && continue
              # validate against ALL
              if echo " $ALL " | grep -q " $m "; then
                if ! echo " $selected " | grep -q " $m "; then
                  selected="$selected $m"
                fi
              else
                echo "::error::Invalid market '$m'. Allowed: $ALL or 'all'"
                exit 1
              fi
            done

            # if user typed only invalid/empty entries
            selected="$(echo "$selected" | xargs || true)"
            if [ -z "$selected" ]; then
              echo "::error::No valid markets selected. Allowed: $ALL or 'all'"
              exit 1
            fi
          fi

          # build JSON: {"market":["cn","tw",...]}
          json='{"market":['
          first=1
          for m in $selected; do
            if [ $first -eq 1 ]; then
              first=0
            else
              json="$json,"
            fi
            json="$json\"$m\""
          done
          json="$json']}"

          echo "Selected markets: $selected"
          echo "Matrix JSON: $json"

          echo "markets_normalized=$selected" >> "$GITHUB_OUTPUT"
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  run:
    name: run_shorts ${{ matrix.market }}
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    env:
      # ✅ render_images_* reads this
      GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID }}

      # ✅ youtube_pipeline_safe.py reads this
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}

      # ✅ youtube_pipeline_safe.py reads this
      YOUTUBE_PLAYLIST_MAP_JSON: ${{ secrets.YOUTUBE_PLAYLIST_MAP_JSON }}

      # ✅ avoid matplotlib GUI
      MPLBACKEND: Agg

      # optional: keep run_shorts debug tree default-on; you can still disable per run via args/env
      RUN_SHORTS_DEBUG_TREE: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Echo inputs / selection
        shell: bash
        run: |
          echo "slot=${{ inputs.slot }}"
          echo "images_ymd=${{ inputs.images_ymd }}"
          echo "markets_input=${{ inputs.markets }}"
          echo "markets_selected=${{ needs.prepare.outputs.markets_normalized }}"
          echo "matrix.market=${{ matrix.market }}"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps (ffmpeg + CJK fonts)
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-noto-cjk fonts-noto-cjk-extra
          fc-cache -f -v
          echo "=== font check (Noto CJK) ==="
          fc-list | grep -i "noto.*cjk" | head -n 30 || true

      - name: Install python deps
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            echo "[CI] Installing from requirements-ci.txt"
            pip install -r requirements-ci.txt
          elif [ -f requirements.txt ]; then
            echo "[CI] Installing from requirements.txt"
            pip install -r requirements.txt
          else
            echo "[CI] No requirements file found!"
            exit 1
          fi

      - name: Debug repo tree (optional)
        shell: bash
        run: |
          set -euxo pipefail
          echo "PWD=$(pwd)"
          echo "=== show scripts directory top-level ==="
          ls -la scripts || true
          echo "=== show specific market cli path ==="
          p="scripts/render_images_${{ matrix.market }}/cli.py"
          if [ -f "$p" ]; then
            echo "[OK] $p exists"
          else
            echo "[MISS] $p NOT FOUND"
          fi

      - name: Run shorts
        shell: bash
        run: |
          set -euxo pipefail
          python scripts/run_shorts.py \
            --market ${{ matrix.market }} \
            --slot ${{ inputs.slot }} \
            --full \
            --drive \
            --drive-parent-id "${GDRIVE_ROOT_FOLDER_ID}" \
            --drive-order after_youtube \
            --drive-upload both \
            --drive-images-mode zip \
            --images-ymd ${{ inputs.images_ymd }}

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifacts_${{ matrix.market }}
          path: |
            outputs/**
            media/videos/**
            media/images/**/list_video.txt
          if-no-files-found: ignore
