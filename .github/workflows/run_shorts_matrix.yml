# .github/workflows/run_shorts_matrix.yml
name: Run Shorts (matrix)

on:
  workflow_dispatch:
    inputs:
      slot:
        description: "slot (midday/close/open)"
        required: true
        default: "midday"
        type: choice
        options:
          - open
          - midday
          - close

      images_ymd:
        description: "images ymd (latest | payload | requested | YYYY-MM-DD)"
        required: true
        default: "latest"
        type: string

      # ✅ NEW: preset selector (no typing)
      markets_preset:
        description: "markets preset (no typing)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - asia        # cn tw jp kr th hk
          - west        # us ca au uk
          - eu          # uk (placeholder for future)
          - single      # choose ONE market from dropdown
          - custom      # use custom_markets string

      # ✅ NEW: single market dropdown
      market_single:
        description: "single market (used only when markets_preset=single)"
        required: true
        default: "jp"
        type: choice
        options:
          - cn
          - tw
          - jp
          - kr
          - th
          - hk
          - us
          - ca
          - uk
          - au
          - in

      # ✅ NEW: optional custom string (only for custom)
      custom_markets:
        description: "custom markets (comma-separated, only used when markets_preset=custom)"
        required: false
        default: ""
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      markets_normalized: ${{ steps.set-matrix.outputs.markets_normalized }}

    steps:
      - name: Build matrix
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          ALL="cn tw jp kr th hk us ca uk au in"
          ASIA="cn tw jp kr th hk"
          WEST="us ca au uk"
          EU="uk"

          preset="${{ inputs.markets_preset }}"
          single="${{ inputs.market_single }}"
          custom="${{ inputs.custom_markets }}"

          preset="$(echo "$preset" | tr '[:upper:]' '[:lower:]' | tr -d ' ')"
          single="$(echo "$single" | tr '[:upper:]' '[:lower:]' | tr -d ' ')"
          custom="$(echo "$custom" | tr '[:upper:]' '[:lower:]' | tr -d ' ')"

          selected=""

          case "$preset" in
            all)
              selected="$ALL"
              ;;
            asia)
              selected="$ASIA"
              ;;
            west)
              selected="$WEST"
              ;;
            eu)
              selected="$EU"
              ;;
            single)
              if [ -z "$single" ]; then
                echo "::error::market_single is required when markets_preset=single"
                exit 1
              fi
              if echo " $ALL " | grep -q " $single "; then
                selected="$single"
              else
                echo "::error::Invalid market_single '$single'"
                exit 1
              fi
              ;;
            custom)
              if [ -z "$custom" ]; then
                echo "::error::custom_markets is required when markets_preset=custom"
                exit 1
              fi
              IFS=',' read -r -a arr <<< "$custom"
              for m in "${arr[@]}"; do
                if echo " $ALL " | grep -q " $m "; then
                  selected="$selected $m"
                else
                  echo "::error::Invalid market '$m' in custom_markets"
                  exit 1
                fi
              done
              selected="$(echo "$selected" | xargs)"
              ;;
            *)
              echo "::error::Unknown markets_preset '$preset'"
              exit 1
              ;;
          esac

          json='{"market":['
          first=1
          for m in $selected; do
            if [ $first -eq 1 ]; then first=0; else json="$json,"; fi
            json="$json\"$m\""
          done
          json="$json]}"

          echo "markets_normalized=$selected" >> "$GITHUB_OUTPUT"
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  run:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    env:
      MPLBACKEND: Agg
      # ✅ isolate matplotlib config/cache per matrix job
      MPLCONFIGDIR: $RUNNER_TEMP/mpl-${{ matrix.market }}

      RUN_SHORTS_DEBUG_TREE: "1"
      OVERVIEW_DEBUG_FONTS: "1"
      OVERVIEW_DEBUG_FOOTER: "1"

      # Drive root folder
      GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID }}

      # YouTube secrets
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      YOUTUBE_PLAYLIST_MAP_JSON: ${{ secrets.YOUTUBE_PLAYLIST_MAP_JSON }}

      # (Optional) Drive creds
      GDRIVE_TOKEN_JSON_B64: ${{ secrets.GDRIVE_TOKEN_JSON_B64 }}
      GDRIVE_CLIENT_SECRET_JSON_B64: ${{ secrets.GDRIVE_CLIENT_SECRET_JSON_B64 }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps (FULL FONT STACK)
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y ffmpeg fontconfig
          sudo apt-get install -y fonts-dejavu-core fonts-dejavu-extra
          sudo apt-get install -y fonts-noto-cjk fonts-noto-core || true
          sudo apt-get install -y fonts-noto-color-emoji || true
          sudo apt-get install -y fonts-noto-extra fonts-noto-ui-core fonts-noto-unhinted || true
          sudo apt-get install -y fonts-noto-cjk-extra || true

          sudo fc-cache -f -v

          echo "---- fc-list (CJK/TC/SC/KR candidates) ----"
          fc-list | grep -iE "noto sans (cjk|tc|sc|kr)|noto serif (cjk|tc|sc|kr)|noto sans (tc|sc|kr)" || true
          echo "------------------------------------------"

          rm -rf ~/.cache/matplotlib ~/.config/matplotlib || true
          rm -rf "${MPLCONFIGDIR}" || true
          mkdir -p "${MPLCONFIGDIR}"

      - name: Install Python deps
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            pip install -r requirements-ci.txt
          else
            pip install -r requirements.txt
          fi

      - name: Rebuild matplotlib font manager (verify)
        shell: bash
        run: |
          set -euxo pipefail
          python - <<'PY'
          import os
          import matplotlib
          matplotlib.use("Agg")
          from matplotlib import font_manager as fm

          print("MPLCONFIGDIR:", os.environ.get("MPLCONFIGDIR"))
          fm._load_fontmanager(try_read_cache=False)

          names = sorted({f.name for f in fm.fontManager.ttflist})
          print("Fonts count:", len(names))
          print("Thai sample:", [n for n in names if "thai" in n.lower()][:30])
          print("CJK sample :", [n for n in names if "cjk" in n.lower()][:30])
          PY

      - name: Ensure output directories
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p media/images media/videos outputs

      - name: Run shorts
        shell: bash
        run: |
          set -euxo pipefail
          echo "YT_TOKEN_LEN=${#YOUTUBE_TOKEN_JSON}  YT_PLAYLIST_LEN=${#YOUTUBE_PLAYLIST_MAP_JSON}"

          args=(
            --market ${{ matrix.market }}
            --slot ${{ inputs.slot }}
            --full
            --drive
            --drive-parent-id "${GDRIVE_ROOT_FOLDER_ID}"
            --drive-order after_youtube
            --drive-upload both
            --drive-images-mode zip
            --images-ymd ${{ inputs.images_ymd }}
          )

          if [ -z "${YOUTUBE_TOKEN_JSON:-}" ]; then
            echo "::warning::Missing YOUTUBE_TOKEN_JSON -> skip upload"
            args+=( --skip-upload )
          else
            if [ -z "${YOUTUBE_PLAYLIST_MAP_JSON:-}" ]; then
              echo "::warning::Missing YOUTUBE_PLAYLIST_MAP_JSON -> will skip playlist"
              args+=( --skip-playlist )
            fi
          fi

          python scripts/run_shorts.py "${args[@]}"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifacts_${{ matrix.market }}
          path: |
            outputs/**
            media/videos/**
            media/images/**
          if-no-files-found: ignore
