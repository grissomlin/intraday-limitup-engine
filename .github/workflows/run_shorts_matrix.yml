name: Run Shorts (matrix)

on:
  workflow_dispatch:
    inputs:
      slot:
        description: "slot (midday/close/open)"
        required: true
        default: "midday"
        type: choice
        options:
          - open
          - midday
          - close

      images_ymd:
        description: "images ymd (latest | payload | requested | YYYY-MM-DD)"
        required: true
        default: "latest"
        type: string

      markets:
        description: "markets to run: all | au | au,us,tw"
        required: false
        default: "all"
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      markets_normalized: ${{ steps.set-matrix.outputs.markets_normalized }}

    steps:
      - name: Build matrix
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          ALL="cn tw jp kr th us ca uk au"

          raw="${{ inputs.markets }}"
          raw="$(echo "$raw" | tr '[:upper:]' '[:lower:]' | tr -d ' ')"

          if [ -z "$raw" ] || [ "$raw" = "all" ] || [ "$raw" = "*" ]; then
            selected="$ALL"
          else
            IFS=',' read -r -a arr <<< "$raw"
            selected=""
            for m in "${arr[@]}"; do
              if echo " $ALL " | grep -q " $m "; then
                selected="$selected $m"
              else
                echo "::error::Invalid market '$m'"
                exit 1
              fi
            done
            selected="$(echo "$selected" | xargs)"
          fi

          json='{"market":['
          first=1
          for m in $selected; do
            if [ $first -eq 1 ]; then first=0; else json="$json,"; fi
            json="$json\"$m\""
          done
          json="$json]}"

          echo "markets_normalized=$selected" >> "$GITHUB_OUTPUT"
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  run:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    env:
      MPLBACKEND: Agg
      RUN_SHORTS_DEBUG_TREE: "1"
      OVERVIEW_DEBUG_FONTS: "1"

      GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID }}
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      YOUTUBE_PLAYLIST_MAP_JSON: ${{ secrets.YOUTUBE_PLAYLIST_MAP_JSON }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------------
      # System deps (Fonts: Latin + CJK (TC/SC/JP/KR) + Thai + Emoji)
      # ------------------------------------------------------------
      - name: Install system deps (fonts + ffmpeg)
        run: |
          set -euxo pipefail
          sudo apt-get update

          # ffmpeg + fontconfig
          sudo apt-get install -y \
            ffmpeg \
            fontconfig

          # âœ… Noto families: CJK + core + UI + extra + unhinted (covers Thai/JP/KR/SC/TC reliably)
          sudo apt-get install -y \
            fonts-noto-cjk \
            fonts-noto-core \
            fonts-noto-ui-core \
            fonts-noto-extra \
            fonts-noto-unhinted || true

          # Emoji
          sudo apt-get install -y \
            fonts-noto-color-emoji

          # Rebuild font cache and clear matplotlib cache (force re-scan)
          sudo fc-cache -fv
          rm -rf ~/.cache/matplotlib || true

      # ------------------------------------------------------------
      # Python deps
      # ------------------------------------------------------------
      - name: Install Python deps
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            pip install -r requirements-ci.txt
          else
            pip install -r requirements.txt
          fi

      # ------------------------------------------------------------
      # Rebuild matplotlib font cache + verify key fonts exist
      # ------------------------------------------------------------
      - name: Rebuild matplotlib font manager (verify)
        run: |
          python - <<'PY'
          from matplotlib import font_manager as fm
          fm._load_fontmanager(try_read_cache=False)
          names = sorted({f.name for f in fm.fontManager.ttflist})

          print("Fonts count:", len(names))

          want = [
              "Noto Sans",
              "DejaVu Sans",
              "Noto Sans CJK TC",
              "Noto Sans CJK SC",
              "Noto Sans CJK JP",
              "Noto Sans CJK KR",
              "Noto Sans Thai",
              "Noto Sans Thai UI",
              "Noto Looped Thai",
              "Noto Looped Thai UI",
              "Noto Color Emoji",
          ]

          def has(x): return x in names
          print("\n[FONT CHECK]")
          for n in want:
              print(f"{n:22} : {'OK' if has(n) else 'MISSING'}")

          print("\nThai-related sample:", [n for n in names if "thai" in n.lower()][:50])
          print("CJK-related sample :", [n for n in names if "cjk" in n.lower()][:50])
          print("Noto sample        :", [n for n in names if "noto" in n.lower()][:30])
          PY

      # ------------------------------------------------------------
      # Ensure output dirs exist (CRITICAL FIX)
      # ------------------------------------------------------------
      - name: Ensure output directories
        run: |
          mkdir -p media/images
          mkdir -p media/videos
          mkdir -p outputs

      # ------------------------------------------------------------
      # Run shorts
      # ------------------------------------------------------------
      - name: Run shorts
        run: |
          set -euxo pipefail
          python scripts/run_shorts.py \
            --market ${{ matrix.market }} \
            --slot ${{ inputs.slot }} \
            --full \
            --drive \
            --drive-parent-id "${GDRIVE_ROOT_FOLDER_ID}" \
            --drive-order after_youtube \
            --drive-upload both \
            --drive-images-mode zip \
            --images-ymd ${{ inputs.images_ymd }}

      # ------------------------------------------------------------
      # Upload artifacts
      # ------------------------------------------------------------
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifacts_${{ matrix.market }}
          path: |
            outputs/**
            media/videos/**
            media/images/**
          if-no-files-found: ignore
