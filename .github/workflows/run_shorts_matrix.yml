name: Run Shorts (matrix)

on:
  workflow_dispatch:
    inputs:
      slot:
        description: "slot (midday/close/open)"
        required: true
        default: "midday"
        type: choice
        options:
          - open
          - midday
          - close

      images_ymd:
        description: "images ymd (latest | payload | requested | YYYY-MM-DD)"
        required: true
        default: "latest"
        type: string

      markets:
        description: "markets to run: all | au | au,us,tw (comma-separated, case-insensitive)"
        required: false
        default: "all"
        type: string

jobs:
  prepare:
    name: Prepare matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      markets_normalized: ${{ steps.set-matrix.outputs.markets_normalized }}

    steps:
      - name: Build matrix from input
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          ALL="cn tw jp kr th us ca uk au"

          raw="${{ inputs.markets }}"
          raw="$(echo "$raw" | tr '[:upper:]' '[:lower:]' | tr -d ' ')"

          if [ -z "$raw" ] || [ "$raw" = "all" ] || [ "$raw" = "*" ]; then
            selected="$ALL"
          else
            IFS=',' read -r -a arr <<< "$raw"
            selected=""
            for m in "${arr[@]}"; do
              [ -z "$m" ] && continue
              if echo " $ALL " | grep -q " $m "; then
                if ! echo " $selected " | grep -q " $m "; then
                  selected="$selected $m"
                fi
              else
                echo "::error::Invalid market '$m'. Allowed: $ALL or 'all'"
                exit 1
              fi
            done
            selected="$(echo "$selected" | xargs || true)"
            if [ -z "$selected" ]; then
              echo "::error::No valid markets selected."
              exit 1
            fi
          fi

          json='{"market":['
          first=1
          for m in $selected; do
            if [ $first -eq 1 ]; then
              first=0
            else
              json="$json,"
            fi
            json="$json\"$m\""
          done
          json="$json]}"

          echo "Selected markets: $selected"
          echo "Matrix JSON: $json"

          echo "markets_normalized=$selected" >> "$GITHUB_OUTPUT"
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  run:
    name: run_shorts ${{ matrix.market }}
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    env:
      MPLBACKEND: Agg
      RUN_SHORTS_DEBUG_TREE: "1"
      OVERVIEW_DEBUG_FONTS: "1"

      GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID }}
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      YOUTUBE_PLAYLIST_MAP_JSON: ${{ secrets.YOUTUBE_PLAYLIST_MAP_JSON }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Echo inputs
        run: |
          echo "slot=${{ inputs.slot }}"
          echo "images_ymd=${{ inputs.images_ymd }}"
          echo "markets_selected=${{ needs.prepare.outputs.markets_normalized }}"
          echo "matrix.market=${{ matrix.market }}"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------------
      # Install system dependencies
      # ------------------------------------------------------------
      - name: Install system deps
        run: |
          set -euxo pipefail
          sudo apt-get update

          sudo apt-get install -y \
            ffmpeg \
            fonts-noto-cjk \
            fonts-noto-color-emoji \
            fontconfig

          # TH only: install Thai fonts
          if [ "${{ matrix.market }}" = "th" ]; then
            echo "[TH] Installing Thai fonts"
            sudo apt-get install -y \
              fonts-noto-core \
              fonts-noto-ui-core
          fi

          sudo fc-cache -fv

          rm -rf ~/.cache/matplotlib || true

          echo "=== Installed fonts sample ==="
          fc-list | grep -i -E "noto|thai|cjk" | head -n 100 || true

      # ------------------------------------------------------------
      # Python deps
      # ------------------------------------------------------------
      - name: Install Python deps
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            pip install -r requirements-ci.txt
          else
            pip install -r requirements.txt
          fi

      # ------------------------------------------------------------
      # Rebuild matplotlib font cache
      # ------------------------------------------------------------
      - name: Rebuild matplotlib font manager
        run: |
          python - <<'PY'
          from matplotlib import font_manager as fm
          fm._load_fontmanager(try_read_cache=False)
          names = sorted({f.name for f in fm.fontManager.ttflist})
          hit = [n for n in names if "noto" in n.lower() or "thai" in n.lower() or "cjk" in n.lower()]
          print("Total fonts:", len(names))
          print("Sample:", hit[:80])
          PY

      # ------------------------------------------------------------
      # Run
      # ------------------------------------------------------------
      - name: Run shorts
        run: |
          set -euxo pipefail
          python scripts/run_shorts.py \
            --market ${{ matrix.market }} \
            --slot ${{ inputs.slot }} \
            --full \
            --drive \
            --drive-parent-id "${GDRIVE_ROOT_FOLDER_ID}" \
            --drive-order after_youtube \
            --drive-upload both \
            --drive-images-mode zip \
            --images-ymd ${{ inputs.images_ymd }}

      # ------------------------------------------------------------
      # Upload artifacts
      # ------------------------------------------------------------
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifacts_${{ matrix.market }}
          path: |
            outputs/**
            media/videos/**
            media/images/**
          if-no-files-found: ignore
