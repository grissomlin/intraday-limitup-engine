name: Run Shorts (auto: open+3h, once/day)

on:
  schedule:
    # GitHub Actions cron uses UTC.
    - cron: "*/10 * * * *"   # every 10 minutes

  workflow_dispatch:
    inputs:
      slot:
        description: "slot (open/midday/close)"
        required: true
        default: "midday"
        type: choice
        options:
          - open
          - midday
          - close

      images_ymd:
        description: "images ymd (latest | payload | requested | YYYY-MM-DD)"
        required: true
        default: "latest"
        type: string

      markets:
        description: "markets to run: auto | all | au | au,us,tw (comma-separated, case-insensitive)"
        required: false
        default: "auto"
        type: string

jobs:
  plan:
    name: plan markets (auto=open+3h) or manual selection
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.plan.outputs.should_run }}
      matrix_json: ${{ steps.plan.outputs.matrix_json }}
      slot: ${{ steps.plan.outputs.slot }}
      images_ymd: ${{ steps.plan.outputs.images_ymd }}
    steps:
      - name: Decide markets for this tick
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          python - << 'PY'
          import json
          import os
          from datetime import datetime, time, timedelta, timezone
          try:
            from zoneinfo import ZoneInfo
          except Exception as e:
            raise SystemExit(f"zoneinfo not available: {e}")

          # -----------------------------
          # Inputs (works for schedule + workflow_dispatch)
          # -----------------------------
          event_name = os.getenv("GITHUB_EVENT_NAME", "")
          in_slot = (os.getenv("INPUT_SLOT", "") or "").strip().lower()
          in_images_ymd = (os.getenv("INPUT_IMAGES_YMD", "") or "").strip()
          in_markets = (os.getenv("INPUT_MARKETS", "") or "").strip().lower().replace(" ", "")

          slot = in_slot if (event_name == "workflow_dispatch" and in_slot) else "midday"
          images_ymd = in_images_ymd if (event_name == "workflow_dispatch" and in_images_ymd) else "latest"
          markets_mode = in_markets if (event_name == "workflow_dispatch" and in_markets) else "auto"

          # Canonical list (keep aligned with repo)
          ALL = ["cn","tw","jp","kr","th","us","ca","uk","au"]

          # ✅ optional test-only switch (set env RUN_SHORTS_TEST_ONLY=1 to limit markets)
          if (os.getenv("RUN_SHORTS_TEST_ONLY","").strip() in ("1","true","yes","y","on")):
            ALL = ["us","ca","au"]

          # --- Market timezone mapping (IANA) ---
          MARKET_TZ = {
            "cn": "Asia/Shanghai",
            "tw": "Asia/Taipei",
            "jp": "Asia/Tokyo",
            "kr": "Asia/Seoul",
            "th": "Asia/Bangkok",
            "uk": "Europe/London",
            "au": "Australia/Sydney",
            "us": "America/New_York",
            "ca": "America/Toronto",
          }

          # --- Market open times (LOCAL market time) ---
          OPEN_LOCAL = {
            "cn": time(9, 30),
            "tw": time(9, 0),
            "jp": time(9, 0),
            "kr": time(9, 0),
            "th": time(9, 30),
            "uk": time(8, 0),
            "au": time(10, 0),
            "us": time(9, 30),
            "ca": time(9, 30),
          }

          # cron is every 10 min; runner start can be delayed
          # ✅ test-friendly: 25 min window AFTER target time
          TOLERANCE_MIN = 25

          now_utc = datetime.now(timezone.utc)

          def mk_matrix(markets):
            include = []
            for m in markets:
              tz = ZoneInfo(MARKET_TZ[m])
              local_now = now_utc.astimezone(tz)
              include.append({"market": m, "market_date": local_now.date().isoformat()})
            return {"include": include}

          chosen = []

          if event_name == "workflow_dispatch":
            if markets_mode in ("", "auto"):
              pass
            elif markets_mode in ("all", "*"):
              chosen = ALL[:]
            else:
              parts = [p for p in markets_mode.split(",") if p]
              invalid = [p for p in parts if p not in ALL]
              if invalid:
                raise SystemExit(f"Invalid market(s): {invalid}. Allowed: {ALL} or all/auto")
              seen = set()
              for p in parts:
                if p not in seen:
                  chosen.append(p)
                  seen.add(p)

          if not chosen:
            # auto picker: open + 3h
            for m in ALL:
              tz = ZoneInfo(MARKET_TZ[m])
              local_now = now_utc.astimezone(tz)

              # weekend skip (holidays handled by your pipeline)
              if local_now.weekday() >= 5:
                continue

              open_t = OPEN_LOCAL[m]
              open_dt = datetime.combine(local_now.date(), open_t, tzinfo=tz)
              target_dt = open_dt + timedelta(hours=3)

              # ✅ only accept ticks AFTER target (prevents early duplicates)
              delta_min = (local_now - target_dt).total_seconds() / 60.0
              if 0 <= delta_min <= TOLERANCE_MIN:
                chosen.append(m)

          matrix = mk_matrix(chosen)

          out = {
            "event_name": event_name,
            "slot": slot,
            "images_ymd": images_ymd,
            "markets_mode": markets_mode,
            "chosen": chosen,
            "matrix": matrix,
            "now_utc": now_utc.isoformat(timespec="seconds"),
          }

          print("PLAN_OUT=" + json.dumps(out, ensure_ascii=False))
          print("MATRIX_JSON=" + json.dumps(matrix))
          print("SHOULD_RUN=" + ("true" if len(chosen) > 0 else "false"))
          print("SLOT=" + slot)
          print("IMAGES_YMD=" + images_ymd)
          PY | tee plan.log

          MATRIX_JSON="$(grep '^MATRIX_JSON=' plan.log | head -n1 | sed 's/^MATRIX_JSON=//')"
          SHOULD_RUN="$(grep '^SHOULD_RUN=' plan.log | head -n1 | sed 's/^SHOULD_RUN=//')"
          SLOT="$(grep '^SLOT=' plan.log | head -n1 | sed 's/^SLOT=//')"
          IMAGES_YMD="$(grep '^IMAGES_YMD=' plan.log | head -n1 | sed 's/^IMAGES_YMD=//')"

          echo "matrix_json=${MATRIX_JSON}" >> "$GITHUB_OUTPUT"
          echo "should_run=${SHOULD_RUN}" >> "$GITHUB_OUTPUT"
          echo "slot=${SLOT}" >> "$GITHUB_OUTPUT"
          echo "images_ymd=${IMAGES_YMD}" >> "$GITHUB_OUTPUT"

  run:
    name: run_shorts ${{ matrix.market }}
    needs: plan
    if: needs.plan.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.plan.outputs.matrix_json) }}

    concurrency:
      group: run_shorts_open3h_${{ matrix.market }}_${{ matrix.market_date }}
      cancel-in-progress: true

    env:
      # ✅ test-only: limit to US/CA/AU (set to "0" later)
      RUN_SHORTS_TEST_ONLY: "1"

      # Google Drive
      GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID }}
      GDRIVE_TOKEN_B64: ${{ secrets.GDRIVE_TOKEN_B64 }}
      GDRIVE_CLIENT_SECRET_B64: ${{ secrets.GDRIVE_CLIENT_SECRET_B64 }}
      GDRIVE_ALLOW_INTERACTIVE: "0"

      # YouTube
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      YOUTUBE_PLAYLIST_MAP_JSON: ${{ secrets.YOUTUBE_PLAYLIST_MAP_JSON }}

      # matplotlib
      MPLBACKEND: Agg

      # optional debug
      RUN_SHORTS_DEBUG_TREE: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Echo plan
        shell: bash
        run: |
          echo "slot=${{ needs.plan.outputs.slot }}"
          echo "images_ymd=${{ needs.plan.outputs.images_ymd }}"
          echo "market=${{ matrix.market }}"
          echo "market_date=${{ matrix.market_date }}"
          echo "event=${{ github.event_name }}"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            echo "[CI] Installing from requirements-ci.txt"
            pip install -r requirements-ci.txt
          elif [ -f requirements.txt ]; then
            echo "[CI] Installing from requirements.txt"
            pip install -r requirements.txt
          else
            echo "[CI] No requirements file found!"
            exit 1
          fi

      - name: Run shorts
        run: |
          set -euxo pipefail
          python scripts/run_shorts.py \
            --market ${{ matrix.market }} \
            --slot "${{ needs.plan.outputs.slot }}" \
            --full \
            --privacy private \
            --drive \
            --drive-parent-id "${GDRIVE_ROOT_FOLDER_ID}" \
            --drive-order after_youtube \
            --drive-upload both \
            --drive-images-mode zip \
            --images-ymd "${{ needs.plan.outputs.images_ymd }}"

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifacts_${{ matrix.market }}_${{ matrix.market_date }}
          path: |
            outputs/**
            media/videos/**
            media/images/**/list_video.txt
          if-no-files-found: ignore
