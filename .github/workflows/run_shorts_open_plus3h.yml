name: Run Shorts (auto: open+3h, once/day)

on:
  schedule:
    # GitHub Actions cron uses UTC.
    # We run frequently and decide which markets should run based on market local time (handles DST).
    - cron: "*/10 * * * *"   # every 10 minutes
  workflow_dispatch:
    inputs:
      slot:
        description: "slot (midday/close/open)"
        required: true
        default: "midday"
      images_ymd:
        description: "images ymd (latest or YYYY-MM-DD)"
        required: true
        default: "latest"

jobs:
  plan:
    name: plan markets to run (open+3h)
    runs-on: ubuntu-latest
    outputs:
      matrix_json: ${{ steps.plan.outputs.matrix_json }}
      should_run: ${{ steps.plan.outputs.should_run }}
      slot: ${{ steps.plan.outputs.slot }}
      images_ymd: ${{ steps.plan.outputs.images_ymd }}
      # For concurrency (unique per market per day)
      market_date_map_json: ${{ steps.plan.outputs.market_date_map_json }}
    steps:
      - name: Decide markets for this tick
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          # If manual dispatch, honor inputs; otherwise default for scheduled run.
          SLOT="${{ github.event_name == 'workflow_dispatch' && inputs.slot || 'midday' }}"
          IMAGES_YMD="${{ github.event_name == 'workflow_dispatch' && inputs.images_ymd || 'latest' }}"

          python - << 'PY' > plan_out.json
          import json
          from datetime import datetime, time, timedelta, timezone
          try:
            from zoneinfo import ZoneInfo
          except Exception as e:
            raise SystemExit(f"zoneinfo not available: {e}")

          # --- Market timezone mapping (IANA) ---
          MARKET_TZ = {
            "cn": "Asia/Shanghai",
            "tw": "Asia/Taipei",
            "jp": "Asia/Tokyo",
            "kr": "Asia/Seoul",
            "th": "Asia/Bangkok",
            "uk": "Europe/London",
            "au": "Australia/Sydney",
            "us": "America/New_York",
            "ca": "America/Toronto",
          }

          # --- Market open times (LOCAL market time) ---
          # Define "open" as first session open.
          OPEN_LOCAL = {
            "cn": time(9, 30),
            "tw": time(9, 0),
            "jp": time(9, 0),
            "kr": time(9, 0),
            "th": time(9, 30),
            "uk": time(8, 0),
            "au": time(9, 59),
            "us": time(9, 30),
            "ca": time(9, 30),
          }

          # schedule is every 10 minutes; keep a small window.
          TOLERANCE_MIN = 6

          now_utc = datetime.now(timezone.utc)

          chosen = []
          # market -> market_local_date string (YYYY-MM-DD)
          market_date_map = {}

          for m, tzname in MARKET_TZ.items():
            tz = ZoneInfo(tzname)
            local_now = now_utc.astimezone(tz)

            # weekend skip here (holidays handled by your pipeline when allow-nontrading is NOT used)
            if local_now.weekday() >= 5:
              continue

            open_t = OPEN_LOCAL[m]
            open_dt = datetime.combine(local_now.date(), open_t, tzinfo=tz)
            target_dt = open_dt + timedelta(hours=3)

            delta_min = abs((local_now - target_dt).total_seconds()) / 60.0
            if delta_min <= TOLERANCE_MIN:
              chosen.append(m)
              market_date_map[m] = local_now.date().isoformat()

          out = {
            "matrix": {"market": chosen},
            "market_date_map": market_date_map,
          }
          print(json.dumps(out))
          PY

          MATRIX_JSON="$(python - << 'PY'
          import json
          d=json.load(open("plan_out.json","r",encoding="utf-8"))
          print(json.dumps(d["matrix"]))
          PY
          )"

          MARKET_DATE_MAP_JSON="$(python - << 'PY'
          import json
          d=json.load(open("plan_out.json","r",encoding="utf-8"))
          print(json.dumps(d["market_date_map"]))
          PY
          )"

          echo "Chosen markets matrix: ${MATRIX_JSON}"
          echo "Market local dates map: ${MARKET_DATE_MAP_JSON}"

          if echo "${MATRIX_JSON}" | grep -q '"market":\s*\[\s*\]'; then
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          fi

          echo "matrix_json=${MATRIX_JSON}" >> "$GITHUB_OUTPUT"
          echo "market_date_map_json=${MARKET_DATE_MAP_JSON}" >> "$GITHUB_OUTPUT"
          echo "slot=${SLOT}" >> "$GITHUB_OUTPUT"
          echo "images_ymd=${IMAGES_YMD}" >> "$GITHUB_OUTPUT"

  run:
    name: run_shorts ${{ matrix.market }}
    needs: plan
    if: needs.plan.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.plan.outputs.matrix_json) }}

    # âœ… de-dup: same market, same market-local date, only keep one run
    # If the workflow triggers twice in the window, concurrency prevents duplicate runs for that market/day.
    concurrency:
      group: run_shorts_open3h_${{ matrix.market }}_${{ fromJSON(needs.plan.outputs.market_date_map_json)[matrix.market] }}
      cancel-in-progress: true

    env:
      GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID }}
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      YOUTUBE_PLAYLIST_MAP_JSON: ${{ secrets.YOUTUBE_PLAYLIST_MAP_JSON }}
      MPLBACKEND: Agg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-ci.txt ]; then
            echo "[CI] Installing from requirements-ci.txt"
            pip install -r requirements-ci.txt
          elif [ -f requirements.txt ]; then
            echo "[CI] Installing from requirements.txt"
            pip install -r requirements.txt
          else
            echo "[CI] No requirements file found!"
            exit 1
          fi

      - name: Run shorts (auto open+3h, once/day)
        run: |
          set -euxo pipefail
          python scripts/run_shorts.py \
            --market ${{ matrix.market }} \
            --slot "${{ needs.plan.outputs.slot }}" \
            --full \
            --drive \
            --drive-parent-id "${GDRIVE_ROOT_FOLDER_ID}" \
            --drive-order after_youtube \
            --drive-upload both \
            --drive-images-mode zip \
            --images-ymd "${{ needs.plan.outputs.images_ymd }}"

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifacts_${{ matrix.market }}
          path: |
            outputs/**
            media/videos/**
            media/images/**/list_video.txt
          if-no-files-found: ignore
